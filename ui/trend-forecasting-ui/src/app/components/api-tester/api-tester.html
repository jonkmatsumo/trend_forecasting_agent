<div class="api-tester-container">
  <div class="sidebar">
    <h3>API Endpoints</h3>
    <div class="endpoint-list">
      <div *ngFor="let endpoint of endpoints"
           class="endpoint-item"
           [ngClass]="{'active': selectedEndpoint === endpoint}"
           (click)="selectEndpoint(endpoint)">
        <div class="endpoint-method" [ngClass]="'method--' + endpoint.method.toLowerCase()">
          {{ endpoint.method }}
        </div>
        <div class="endpoint-info">
          <div class="endpoint-name">{{ endpoint.name }}</div>
          <div class="endpoint-path">{{ endpoint.path }}</div>
        </div>
      </div>
    </div>
  </div>

  <div class="main-content">
    <div class="request-section">
      <h3>Request Configuration</h3>
      
      <form [formGroup]="requestForm" class="request-form">
        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Base URL</mat-label>
            <input matInput formControlName="baseUrl">
          </mat-form-field>
          
          <mat-form-field appearance="outline">
            <mat-label>Path</mat-label>
            <input matInput formControlName="path">
          </mat-form-field>
          
          <mat-form-field appearance="outline">
            <mat-label>Method</mat-label>
            <mat-select formControlName="method">
              <mat-option value="GET">GET</mat-option>
              <mat-option value="POST">POST</mat-option>
              <mat-option value="PUT">PUT</mat-option>
              <mat-option value="DELETE">DELETE</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Headers</mat-label>
            <textarea matInput formControlName="headers" rows="3"></textarea>
          </mat-form-field>
        </div>

        <div class="form-row" *ngIf="requestForm.value.method !== 'GET'">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Request Body</mat-label>
            <textarea matInput formControlName="body" rows="10"></textarea>
          </mat-form-field>
        </div>

        <div class="form-actions">
          <button mat-raised-button 
                  color="primary"
                  [disabled]="requestForm.invalid || loadingService.isLoading('api-request')"
                  (click)="sendRequest()">
            <mat-icon>send</mat-icon>
            {{ loadingService.isLoading('api-request') ? 'Sending...' : 'Send Request' }}
          </button>
        </div>
      </form>
    </div>

    <div class="response-section" *ngIf="response || error">
      <h3>Response</h3>
      
      <div *ngIf="error" class="error-message">
        <mat-icon>error</mat-icon>
        {{ error }}
      </div>

      <div *ngIf="response" class="response-content">
        <div class="response-header">
          <span class="status-code" [ngClass]="'status--' + (response.status < 400 ? 'success' : 'error')">
            {{ response.status }}
          </span>
          <span class="response-time">{{ response.responseTime }}ms</span>
        </div>

        <div class="response-body">
          <div class="response-tabs">
            <button mat-button [class.active]="true">Response</button>
            <button mat-button (click)="copyToClipboard(formatJson(response))">
              <mat-icon>content_copy</mat-icon>
              Copy
            </button>
          </div>
          
          <pre class="response-json">{{ formatJson(response.data) }}</pre>
        </div>
      </div>
    </div>

    <!-- Backend Integration Testing Section -->
    <div class="integration-testing-section">
      <h3>Backend Integration Testing</h3>
      
      <div class="integration-controls">
        <button mat-raised-button 
                color="primary"
                [disabled]="isRunningIntegrationTests"
                (click)="runIntegrationTests()">
          <mat-icon>play_arrow</mat-icon>
          Run Full Integration Test
        </button>
        
        <button mat-raised-button 
                color="accent"
                (click)="testCorsConfiguration()">
          <mat-icon>security</mat-icon>
          Test CORS
        </button>
        
        <button mat-raised-button 
                color="accent"
                (click)="testProxyConfiguration()">
          <mat-icon>router</mat-icon>
          Test Proxy
        </button>
      </div>

      <!-- Integration Test Results -->
      <div *ngIf="integrationTestResults" class="integration-results">
        <h4>Integration Test Results</h4>
        
        <div class="test-summary">
          <div class="summary-item">
            <span class="label">Total Tests:</span>
            <span class="value">{{ integrationTestResults.summary.total }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Successful:</span>
            <span class="value success">{{ integrationTestResults.summary.successful }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Failed:</span>
            <span class="value error">{{ integrationTestResults.summary.failed }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Avg Response Time:</span>
            <span class="value">{{ integrationTestResults.summary.averageResponseTime }}ms</span>
          </div>
        </div>

        <div class="test-results">
          <div *ngFor="let test of integrationTestResults.tests" 
               class="test-result-item"
               [ngClass]="'status--' + test.status">
            <div class="test-header">
              <mat-icon [color]="getStatusColor(test.status)">
                {{ getStatusIcon(test.status) }}
              </mat-icon>
              <span class="test-endpoint">{{ test.endpoint }}</span>
              <span class="test-time" *ngIf="test.responseTime">
                {{ test.responseTime }}ms
              </span>
            </div>
            
            <div *ngIf="test.error" class="test-error">
              {{ test.error }}
            </div>
            
            <div *ngIf="test.data && test.status === 'success'" class="test-data">
              <pre>{{ formatJson(test.data) }}</pre>
            </div>
          </div>
        </div>
      </div>

      <!-- CORS Test Results -->
      <div *ngIf="corsTestResult" class="cors-test-results">
        <h4>CORS Configuration Test</h4>
        <div class="test-result-item" [ngClass]="'status--' + corsTestResult.status">
          <div class="test-header">
            <mat-icon [color]="getStatusColor(corsTestResult.status)">
              {{ getStatusIcon(corsTestResult.status) }}
            </mat-icon>
            <span class="test-endpoint">{{ corsTestResult.endpoint }}</span>
          </div>
          
          <div *ngIf="corsTestResult.data?.corsHeaders" class="cors-headers">
            <h5>CORS Headers:</h5>
            <pre>{{ formatJson(corsTestResult.data.corsHeaders) }}</pre>
          </div>
        </div>
      </div>

      <!-- Proxy Test Results -->
      <div *ngIf="proxyTestResults" class="proxy-test-results">
        <h4>Proxy Configuration Test</h4>
        <div *ngFor="let test of proxyTestResults" 
             class="test-result-item"
             [ngClass]="'status--' + test.status">
          <div class="test-header">
            <mat-icon [color]="getStatusColor(test.status)">
              {{ getStatusIcon(test.status) }}
            </mat-icon>
            <span class="test-endpoint">{{ test.endpoint }}</span>
          </div>
          
          <div *ngIf="test.error" class="test-error">
            {{ test.error }}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
